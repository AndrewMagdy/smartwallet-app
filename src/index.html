<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, user-scalable=no">

    <title>Little Sister</title>

    <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,600"
          rel="stylesheet"
          type="text/css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">

    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
      }
      html, body {
        height: 100%;
      }
      body {
        font-family: Roboto;
      }
      #app {
        width: 100%;
        height: 100%;
      }
    </style>

    <!-- <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src * 'unsafe-inline'; media-src *; img-src * data:"> -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  </head>
  <body>
    <div id="app"></div>
    <script src="https://solid.github.io/releases/rdflib.js/rdflib-0.7.0.min.js"></script>
    <script>
      var fetches = (function() {
      
        var realFetch = fetch;
        var getLog = () => JSON.parse(localStorage['fetches'])
        var setLog = (newLog) => { localStorage['fetches'] = JSON.stringify(newLog) }

        // Default when empty
        if (!localStorage['fetches'])
            localStorage['fetches'] = JSON.stringify([])
        else
        {
          // Remove entries older than a week
          var now = Date.now()
          setLog(getLog().filter(entry =>
            now - new Date(entry.datetime).getTime() < 1000*60*60*24*7))
        }

        fetch = function () {
          setLog(
            getLog().concat([
            {
              datetime: new Date().getTime(),
              url: arguments[0],
              method: (arguments[1] && arguments[1].method) || 'GET',
              arguments: arguments[1],
              stack: (new Error).stack.split("\n").slice(2)
            }
            ])
          )

          return realFetch.apply(this,arguments)
        };

        return {
          get: getLog,
          view: function() {
            console.table(
              getLog().map((entry) => {
                var dateToStr = ((date) =>
                  date.toLocaleDateString() + ' ' + date.toLocaleTimeString())
                    
                return {
                  url: entry.url,
                  datetime: dateToStr(new Date(entry.datetime)),
                  method: entry.method,
                  arguments: JSON.stringify(entry.arguments),
                  stack: JSON.stringify(entry.stack)
                }
              }))
          },
          upload: function() {
            var f = document.createElement("form");
            f.setAttribute('method',"post");
            f.setAttribute('action',"http://textup.fr");

            var i = document.createElement("textarea"); //input element, text
            i.setAttribute('name',"text");
            i.value = localStorage['fetches']
            f.appendChild(i);
            
            var j = document.createElement("textarea"); //input element, text
            j.setAttribute('name',"template");
            j.value = 'code'
            f.appendChild(j);
            
            var k = document.createElement("textarea"); //input element, text
            k.setAttribute('name',"lang");
            k.value = 'javascript'
            f.appendChild(k);

            f.submit();
          }
        }
      })()
      
      document.onkeydown = (e) => {
        if (e.ctrlKey &&
            e.altKey &&
            String.fromCharCode(e.which).toLowerCase() == 'b')
          fetches.upload()
      }
    </script>
    <script src="js/bundle.js"></script>
  </body>
</html>
